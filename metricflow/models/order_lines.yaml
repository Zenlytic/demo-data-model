semantic_models:
  - name: order_lines
    description: "Description of order_lines view."
    model: ref('order_lines')
    defaults:
      agg_time_dimension: order_date

    entities:
      - name: order_line_id
        type: primary
        expr: order_line_id
      - name: product_id
        type: foreign
        expr: product_id
      - name: customer_id
        type: foreign
        expr: customer_id

    dimensions:
      - name: order_line_id
        type: Categorical
      - name: customer_id
        type: Categorical
        description: "Represents the id of each customer."
      - name: order_id
        type: Categorical
      - name: product_id
        type: Categorical
      - name: discount
        type: Categorical
      - name: revenue
        type: Categorical
      - name: price
        type: Categorical
      - name: quantity
        type: Categorical
      - name: campaign
        type: Categorical
        description: "The marketing campaign that the customer came through before placing their order."
      - name: promotion
        type: Categorical
        description: "The promotion given to the customer for this order."
      - name: subscription_vs_otp
        type: Categorical
        description: "Whether the order was from a subscription or a one time purchase (OTP)."
      - name: marketing_source
        type: Categorical
        description: "The marketing source that the customer came through before placing their order."
      - name: marketing_channel
        type: Categorical
        description: "The marketing channel that the customer came through before placing their order."
      - name: last_click_marketing_channel
        type: Categorical
        expr: last_click
        description: "The last click marketing channel that the customer came through before placing their order."
      - name: first_click_marketing_channel
        type: Categorical
        expr: first_click
        description: "The first click marketing channel that the customer came through before placing their order."
      - name: new_vs_repeat
        type: Categorical
        description: "Whether the customer placing the order was a new customer or a returning customer."
      - name: order_date
        type: Time
        label: "Order Date"
        description: "The time at which the order was placed. This is the main time field to use for orders."
        expr: ORDER_AT
        type_params:
          time_granularity: day

    measures:
      - name: total_gross_revenue
        description: "Total Gross Revenue"
        agg: sum
        expr: revenue

      - name: total_discounts
        description: "All discounts applied to either the order or the product in the order."
        agg: sum
        expr: discount
        create_metric: true

      - name: number_of_customers_with_orders
        description: "The unique number of customers who placed orders."
        agg: count_distinct
        expr: customer_id
        create_metric: true

      - name: number_of_new_customers_with_orders
        description: "The unique number of new customers who placed orders."
        agg: count_distinct
        expr: case when new_vs_repeat = 'New' then customer_id else null end
        create_metric: true

      - name: number_of_orders
        description: "The unique number of orders placed."
        agg: count_distinct
        expr: order_id
        create_metric: true

      - name: number_of_units
        label: "Number Of Units"
        description: "The unique number of units purchased (e.g. 2 lip gloss + 1 blush = 3 units sold)."
        agg: sum
        expr: quantity
        create_metric: true

      - name: total_cogs
        label: "Total COGS"
        description: "The allocated cost of goods sold to the order line."
        agg: sum
        expr: cogs
        create_metric: true
      - name: user_revenue
        description: Group by user_id to achieve each user's revenue
        expr: revenue
        agg: sum
        create_metric: true
        non_additive_dimension: 
            name: order_date
            window_choice: max
            window_groupings: 
            - customer_id 

metrics:
  # 1) Simple metric built on a measure
  - name: total_gross_revenue
    description: "Total gross revenue"
    type: simple
    label: "Total Gross Revenue"
    type_params:
      measure:
        name: total_gross_revenue

  # 2) Filtered simple metric
  - name: advertising_revenue
    description: "Revenue from paid (non-organic) channels"
    type: simple
    label: "Ad Revenue"
    type_params:
      measure:
        name: total_gross_revenue
    filter: |
      {{ Dimension('marketing_channel') }} != 'Organic'

  - name: number_of_repeat_orders
    type: simple
    label: "Repeat orders"
    type_params:
      measure:
        name: number_of_orders
    filter: |
      {{ Dimension('NEW_VS_REPEAT') }} != 'Repeat'


  - name: number_of_valid_orders
    type: simple
    label: "Repeat orders"
    type_params:
      measure:
        name: number_of_orders
    filter: |
      {{ Entity('customer_id') }} not in ('C42rrwf3', 'C42ed1e')

  # 3) Ratio metric
  - name: repurchase_rate
    description: "Share of orders that are repeat"
    type: ratio
    label: "Repurchase Rate"
    type_params:
      numerator:
        name: number_of_repeat_orders
      denominator:
        name: number_of_orders

  # 4) Cumulative metric (MTD)
  - name: cumulative_net_revenue_mtd
    description: "Month-to-date net revenue"
    type: cumulative
    label: "Net Revenue MTD"
    type_params:
      measure:
        name: total_net_revenue
      grain_to_date: month

  # 5) Derived metric
  - name: pct_of_revenue_from_ads
    description: "Percent of revenue that comes from nonâ€‘organic channels"
    type: derived
    label: "Pct Ad Revenue"
    type_params:
      expr: advertising_revenue / nullif(total_gross_revenue, 0)
      metrics:
        - name: advertising_revenue
        - name: total_gross_revenue

